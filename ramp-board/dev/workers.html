

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>5. Notes regarding the RAMP workers &mdash; RAMP 0.8.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/js/copybutton.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/ramp.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="6. Interactions with the RAMP website" href="frontend.html" />
    <link rel="prev" title="4. Create New Challenge" href="create_new_challenge.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> RAMP
          

          
          </a>

          
            
            
              <div class="version">
                0.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="contribute.html">Develop and contribute</a></li>
</ul>
<p class="caption"><span class="caption-text">Documentation</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="user_guide.html">User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="setup_server.html">1. Set up your own server to run RAMP</a></li>
<li class="toctree-l2"><a class="reference internal" href="personalize.html">2. Personalize your RAMP instance</a></li>
<li class="toctree-l2"><a class="reference internal" href="create_ramp_event.html">3. Set up a new RAMP event</a></li>
<li class="toctree-l2"><a class="reference internal" href="create_new_challenge.html">4. Create New Challenge</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5. Notes regarding the RAMP workers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#running-submissions-in-a-conda-environment">5.1. Running submissions in a Conda environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-submissions-on-amazon-web-services-aws">5.2. Running submissions on Amazon Web Services (AWS)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#launching-aws-instance">5.2.1. Launching AWS instance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#prepare-the-instance">5.2.2. Prepare the instance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#event-configuration">5.2.3. Event configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#running-submissions-with-dask">5.3. Running submissions with Dask</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#daskworker-setup-of-the-main-server">5.3.1. DaskWorker setup of the main server</a></li>
<li class="toctree-l4"><a class="reference internal" href="#daskworker-setup-with-a-local-cluster">5.3.2. DaskWorker setup with a local cluster</a></li>
<li class="toctree-l4"><a class="reference internal" href="#daskworker-setup-with-a-remote-cluster">5.3.3. DaskWorker setup with a remote cluster</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#create-your-own-worker">5.4. Create your own worker</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="frontend.html">6. Interactions with the RAMP website</a></li>
<li class="toctree-l2"><a class="reference internal" href="running_challenge.html">7. Useful tips using RAMP</a></li>
<li class="toctree-l2"><a class="reference internal" href="server-maintenance.html">8. Server maintenance</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">RAMP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">RAMP Command-Line Interface</a></li>
</ul>
<p class="caption"><span class="caption-text">Addtional Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="whats_new.html">Release history</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">About us</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">RAMP</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="user_guide.html">User Guide</a> &raquo;</li>
        
      <li><span class="section-number">5. </span>Notes regarding the RAMP workers</li>
    
    

  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="notes-regarding-the-ramp-workers">
<span id="all-workers"></span><h1><span class="section-number">5. </span>Notes regarding the RAMP workers<a class="headerlink" href="#notes-regarding-the-ramp-workers" title="Permalink to this headline">¶</a></h1>
<p>The RAMP “worker” is the object responsible of actually running (training and
evaluating) a submission and returning back the results (predictions and
scores).
The workers are typically launched from a loop set up for a specific event on
the server. The worker can then run the submission either locally on the server
or on a remote machine.</p>
<p>The type of worker used in a certain event is specified in the <code class="docutils literal notranslate"><span class="pre">worker</span></code>
section of the yml configuration file, using the <code class="docutils literal notranslate"><span class="pre">worker_type</span></code> key (see
<a class="reference internal" href="create_ramp_event.html#deploy-ramp-event"><span class="std std-ref">Deploy a specific RAMP event</span></a>). Additional keys can be required depending on
the worker type.</p>
<p>Available workers:</p>
<ul class="simple">
<li><p>The <a class="reference internal" href="generated/ramp_engine.local.CondaEnvWorker.html#ramp_engine.local.CondaEnvWorker" title="ramp_engine.local.CondaEnvWorker"><code class="xref py py-class docutils literal notranslate"><span class="pre">ramp_engine.local.CondaEnvWorker</span></code></a> will run the submission in
a specific isolated conda environment. This worker is specified as
<code class="docutils literal notranslate"><span class="pre">worker_type:</span> <span class="pre">conda</span></code> and requires an additional key <code class="docutils literal notranslate"><span class="pre">conda_env</span></code>
specifying the name of the conda environment.</p></li>
<li><p>The <a class="reference internal" href="generated/ramp_engine.aws.AWSWorker.html#ramp_engine.aws.AWSWorker" title="ramp_engine.aws.AWSWorker"><code class="xref py py-class docutils literal notranslate"><span class="pre">ramp_engine.aws.AWSWorker</span></code></a> will send the submission to an AWS
instance and copy back the results. This worker is specified as
<code class="docutils literal notranslate"><span class="pre">worker_type:</span> <span class="pre">aws</span></code>, and for more details on the setup and configuration,
see below.</p></li>
<li><p>The <a class="reference internal" href="generated/ramp_engine.remote.DaskWorker.html#ramp_engine.remote.DaskWorker" title="ramp_engine.remote.DaskWorker"><code class="xref py py-class docutils literal notranslate"><span class="pre">ramp_engine.remote.DaskWorker</span></code></a> will send the submission to Dask
cluster, which can be local or remote, and copy back the results. This
worker is specified as <code class="docutils literal notranslate"><span class="pre">worker_type:</span> <span class="pre">dask</span></code>. For more details on the setup
and configuration, see below.</p></li>
</ul>
<div class="section" id="running-submissions-in-a-conda-environment">
<span id="conda-env-worker"></span><h2><span class="section-number">5.1. </span>Running submissions in a Conda environment<a class="headerlink" href="#running-submissions-in-a-conda-environment" title="Permalink to this headline">¶</a></h2>
<p>As previously mentioned, the <a class="reference internal" href="generated/ramp_engine.local.CondaEnvWorker.html#ramp_engine.local.CondaEnvWorker" title="ramp_engine.local.CondaEnvWorker"><code class="xref py py-class docutils literal notranslate"><span class="pre">ramp_engine.local.CondaEnvWorker</span></code></a> workers
rely on a Conda environment to execute the submission.</p>
<p>For instance, if you would like to run the <a class="reference external" href="https://github.com/ramp-kits/iris">Iris challenge</a>, the starting kit requires numpy, pandas,
and scikit-learn. Thus, the environment used to run the initial submission
should have these libraries installed, in addition to ramp-workflow.</p>
<p>Subsequently, you can create such environment and use it in the event
configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>~ $ conda create --name ramp-iris pip numpy pandas scikit-learn
~ $ conda activate ramp-iris
~ $ pip install ramp-workflow
</pre></div>
</div>
<p>If you are using a ramp-kit from the <a class="reference external" href="https://github.com/ramp-kits">Paris-Saclay CDS</a>, each kit will provide either an
<code class="docutils literal notranslate"><span class="pre">environment.yml</span></code> or <code class="docutils literal notranslate"><span class="pre">ami_environment.yml</span></code> file which you can use to create
the environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">create</span> <span class="o">--</span><span class="n">name</span> <span class="n">ramp</span><span class="o">-</span><span class="n">iris</span> <span class="o">--</span><span class="n">file</span> <span class="n">environment</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>Alternatively, you can include an <code class="docutils literal notranslate"><span class="pre">environment.yml</span></code> file inside the <code class="docutils literal notranslate"><span class="pre">ramp-kit</span></code>
directory and use the following to install the environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>~/ramp_deployment $ ramp setup create-conda-env --event-config events/iris_test/config.yml
</pre></div>
</div>
<p>You can update an existing environment with the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>~/ramp_deployment $ ramp setup update-conda-env --event-config events/iris_test/config.yml
</pre></div>
</div>
</div>
<div class="section" id="running-submissions-on-amazon-web-services-aws">
<h2><span class="section-number">5.2. </span>Running submissions on Amazon Web Services (AWS)<a class="headerlink" href="#running-submissions-on-amazon-web-services-aws" title="Permalink to this headline">¶</a></h2>
<p>The AWS worker will train and evaluate the submissions on an AWS instance,
which can be useful if the server itself has not much resources or if you need
specific resources (e.g. GPU’s).</p>
<p>Summary of steps:</p>
<ol class="arabic simple">
<li><p>Launch AWS instance and connect to it.</p></li>
<li><p>Prepare the instance for running submissions.</p></li>
<li><p>Save the instance as an Amazon Machine Image (AMI).</p></li>
<li><p>Update the event <code class="docutils literal notranslate"><span class="pre">config.yml</span></code> file on the RAMP server.</p></li>
</ol>
<div class="section" id="launching-aws-instance">
<span id="launch-aws"></span><h3><span class="section-number">5.2.1. </span>Launching AWS instance<a class="headerlink" href="#launching-aws-instance" title="Permalink to this headline">¶</a></h3>
<p>Follow <a class="reference external" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html">AWS getting started</a>
to launch an Amazon EC2 Linux instance. Amazon can create a new key-pair
for your instance, which you can download. You need to store this in a
hidden directory (e.g., <code class="docutils literal notranslate"><span class="pre">.ssh/</span></code>) and change the rights to file permissions
to only read for owner. You can use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>~ $ chmod 400 &lt;path_to_aws_key&gt;
</pre></div>
</div>
<p>To connect to your instance via ssh, use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>~ $ ssh -i /path/my-key-pair.pem my-instance-user-name@my-instance-public-dns-name
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">'my-instance-user-name'</span></code> depends on the type of instance you picked but is
commonly ‘ec2-user’ or ‘ubuntu’. The full list can be found <a class="reference external" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/connection-prereqs.html#connection-prereqs-get-info-about-instance">here</a>
under ‘Get the user name for your instance’. ‘my-instance-public-dns-name’ can
be found by clicking on your ‘Instances’ tab in your EC2 dashboard.
Full connection details can be found in the <a class="reference external" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstancesLinux.html">AWS guide</a>.</p>
</div>
<div class="section" id="prepare-the-instance">
<span id="prepare-instance"></span><h3><span class="section-number">5.2.2. </span>Prepare the instance<a class="headerlink" href="#prepare-the-instance" title="Permalink to this headline">¶</a></h3>
<p>To prepare the instance you need to download the starting kit, data and all
required packages to run submissions. This can be saved as an AMI (image) and
will then be used to launch instances to run submissions.</p>
<p>Below is a basic guide for creating such an AMI manually, using the Iris
challenge. This guide is for an ubuntu instance. If you have a Linux instance
you will not need to add miniconda to your <code class="docutils literal notranslate"><span class="pre">~/.profile</span></code> but you will
need to install git.</p>
<blockquote>
<div><ul>
<li><p>Install miniconda:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>~ $ LATEST_MINICONDA=&quot;http://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh&quot;
~ $ wget -q $LATEST_MINICONDA -O ~/miniconda.sh
~ $ bash ~/miniconda.sh -b
~ $ echo &#39;. ${HOME}/miniconda3/etc/profile.d/conda.sh&#39; &gt;&gt; ~/.profile
~ $ echo &#39;conda activate base&#39; &gt;&gt; ~/.profile
~ $ source .profile
~ $ conda info
~ $ conda update --yes --quiet conda pip
</pre></div>
</div>
</li>
<li><p>Get the starting kit material (e.g. for ‘iris’):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>~ $ RAMPKIT_DIR=&quot;$HOME/ramp-kits&quot;
~ $ project_name=&quot;iris&quot;
~ $ kit_url=&quot;https://github.com/ramp-kits/$project_name&quot;
~ $ kit_dir=&quot;$RAMPKIT_DIR/$project_name&quot;
~ $ git clone $kit_url $kit_dir
</pre></div>
</div>
</li>
<li><p>Update the base conda environment for the needs of the challenge:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>~ $ environment=&quot;$kit_dir/environment.yml&quot;
~ $ conda env update --name base --file $environment
~ $ conda list
</pre></div>
</div>
</li>
<li><p>Get the data and copy private data to <code class="docutils literal notranslate"><span class="pre">ramp-kits/&lt;project&gt;/data/</span></code>.
Note: depending on how <code class="docutils literal notranslate"><span class="pre">prepare_data.py</span></code> structures the data files,
the last command may differ:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>~ $ RAMPDATA_DIR=&quot;$HOME/ramp-data&quot;
~ $ data_url=&quot;https://github.com/ramp-data/$project_name&quot;
~ $ data_dir=&quot;$RAMPDATA_DIR/$project_name&quot;
~ $ git clone $data_url $data_dir
~ $ cd $data_dir
~ $ python prepare_data.py
~ $ cp data/private/* $kit_dir/data/
</pre></div>
</div>
</li>
<li><p>Test the kit:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>~ $ cd $kit_dir
~ $ ramp-test
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
<p>Next, save the instance as an AMI. Starting from the instance tab:
Actions -&gt; Image -&gt; Create image. See <a class="reference external" href="https://docs.aws.amazon.com/toolkit-for-visual-studio/latest/user-guide/tkv-create-ami-from-instance.html">Create an AMI from an Amazon EC2
instance</a>
for more details.</p>
</div>
<div class="section" id="event-configuration">
<h3><span class="section-number">5.2.3. </span>Event configuration<a class="headerlink" href="#event-configuration" title="Permalink to this headline">¶</a></h3>
<p>Create an event config.yml (see <a class="reference internal" href="create_ramp_event.html#deploy-ramp-event"><span class="std std-ref">Deploy a specific RAMP event</span></a>) and update the
‘worker’ section, which should look something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ramp</span><span class="p">:</span>
    <span class="n">problem_name</span><span class="p">:</span> <span class="n">iris</span>
    <span class="n">event_name</span><span class="p">:</span> <span class="n">iris_ramp_aws_test</span>
    <span class="n">event_title</span><span class="p">:</span> <span class="s2">&quot;iris ramp aws test&quot;</span>
    <span class="n">event_is_public</span><span class="p">:</span> <span class="n">true</span>
<span class="n">worker</span><span class="p">:</span>
    <span class="n">worker_type</span><span class="p">:</span> <span class="n">aws</span>
    <span class="n">access_key_id</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">aws_access_key_id</span> <span class="k">for</span> <span class="n">boto3</span> <span class="n">Session</span><span class="o">&gt;</span>
    <span class="n">secret_access_key</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">aws_secret_access_key</span> <span class="k">for</span> <span class="n">boto3</span> <span class="n">Session</span><span class="o">&gt;</span>
    <span class="n">region_name</span><span class="p">:</span> <span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mi">2</span> <span class="c1"># oregon</span>
    <span class="n">ami_image_name</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">AMI</span> <span class="nb">set</span> <span class="n">up</span> <span class="k">for</span> <span class="n">this</span> <span class="n">event</span><span class="o">&gt;</span>
    <span class="n">ami_user_name</span><span class="p">:</span> <span class="n">ubuntu</span>
    <span class="n">instance_type</span><span class="p">:</span> <span class="n">t2</span><span class="o">.</span><span class="n">micro</span>
    <span class="n">use_spot_instance</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">key_name</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">name</span> <span class="n">of</span> <span class="n">your</span> <span class="n">pem</span> <span class="n">file</span><span class="p">,</span> <span class="n">eg</span> <span class="n">iris_key</span><span class="o">&gt;</span>
    <span class="n">security_group</span><span class="p">:</span> <span class="n">launch</span><span class="o">-</span><span class="n">wizard</span><span class="o">-</span><span class="mi">103</span>
    <span class="n">key_path</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">path</span> <span class="n">to</span> <span class="n">pem</span> <span class="n">file</span> <span class="n">corresponding</span> <span class="n">to</span> <span class="n">user</span> <span class="n">name</span><span class="p">,</span> <span class="n">eg</span> <span class="n">my_path</span><span class="o">/</span><span class="n">iris_key</span><span class="o">.</span><span class="n">pem</span><span class="o">&gt;</span>
    <span class="n">remote_ramp_kit_folder</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ubuntu</span><span class="o">/</span><span class="n">ramp</span><span class="o">-</span><span class="n">kits</span><span class="o">/</span><span class="n">iris</span>
    <span class="n">submissions_dir</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ramp</span><span class="o">/</span><span class="n">ramp_deployment</span><span class="o">/</span><span class="n">events</span><span class="o">/</span><span class="n">iris_aws</span><span class="o">/</span><span class="n">submissions</span>
    <span class="n">predictions_dir</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ramp</span><span class="o">/</span><span class="n">ramp_deployment</span><span class="o">/</span><span class="n">events</span><span class="o">/</span><span class="n">iris_aws</span><span class="o">/</span><span class="n">predictions</span>
    <span class="n">logs_dir</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ramp</span><span class="o">/</span><span class="n">ramp_deployment</span><span class="o">/</span><span class="n">events</span><span class="o">/</span><span class="n">iris_aws</span><span class="o">/</span><span class="n">logs</span>
    <span class="n">memory_profiling</span><span class="p">:</span> <span class="n">false</span>
<span class="n">dispatcher</span><span class="p">:</span>
    <span class="n">hunger_policy</span><span class="p">:</span> <span class="n">sleep</span>
    <span class="n">n_workers</span><span class="p">:</span> <span class="mi">5</span>
    <span class="n">n_threads</span><span class="p">:</span> <span class="mi">2</span>
    <span class="n">time_between_collection</span><span class="p">:</span> <span class="mi">60</span>
</pre></div>
</div>
<p><strong>Worker configuration</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">access_key_id</span></code> and <code class="docutils literal notranslate"><span class="pre">secret_access_key</span></code>: to create a new access key, go
to your top navigation bar, click on your user name -&gt; My Security
Credentials. Open the ‘Access keys’ tab then click on ‘Create New Access
Key’. You will be prompted to download your ‘access key ID’ and ‘secret
access key’ to a <code class="docutils literal notranslate"><span class="pre">.csv</span></code> file, which should be saved in a secure location.
You can also use an existing access key by obtaining the ID and key from
your saved <code class="docutils literal notranslate"><span class="pre">.csv</span></code> file. See <a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html#Using_CreateAccessKey">Managing Access Keys</a>
for more details.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">region_name</span></code>: zone of your instance, which can be found in the EC2
console, ‘Instances’ tab on the left, under ‘availability zone’.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ami_image_name</span></code>: name you gave to the image you prepared (see
<a class="reference internal" href="#prepare-instance"><span class="std std-ref">Prepare the instance</span></a>). This can be found in the EC2 console, under
‘Images’ -&gt; ‘AMI’ tab.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ami_user_name</span></code>: user name you used to ssh into your instance.
Commonly ‘ec2-user’ or ‘ubuntu’.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">instance_type</span></code>: found in the EC2 console, ‘Instances’ tab, ‘Description’
tab at the bottom, under ‘Instance type’.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">use_spot_instance</span></code>: boolean, default false. Whether or not to use spot
instances. See <a class="reference external" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-spot-instances.html">AWS</a>
for more information on spot instances.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">key_name</span></code>: name of the key, eg if your key file is ‘iris_key.pem’, the key
name is ‘iris_key’</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">security_group</span></code>: in the EC2 console, ‘Instances’ tab, ‘Description’ tab
at the bottom, under ‘Security groups’.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">key_path</span></code>: path to the you private key used to ssh to your instance
(see <a class="reference internal" href="#launch-aws"><span class="std std-ref">Launching AWS instance</span></a>). Note that you need to copy your key into the RAMP.
It is best to give the absolute path. Ensure the permissions of this file
is set to only ‘read’ by owner (which can be done using <code class="docutils literal notranslate"><span class="pre">chmod</span> <span class="pre">400</span>
<span class="pre">key_name.pem</span></code> command).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">remote_ramp_kit_folder</span></code>: path to the starting kit folder on
the AWS image you prepared (see <a class="reference internal" href="#prepare-instance"><span class="std std-ref">Prepare the instance</span></a>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">submissions_dir</span></code>: path to the submissions directory on the RAMP server.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">predictions_dir</span></code>: path to the predictions directoryon the RAMP server.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logs_dir</span></code>: path to store the submission logs on the RAMP server.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">memory_profiling</span></code>: boolean, whether or not to profile memory used by each
submission. You need to install <a class="reference external" href="https://pypi.org/project/memory-profiler/">memory profiler</a> in your prepared AMI image
to enable this.</p></li>
</ul>
<p id="aws-dispatcher"><strong>Dispatcher configuration</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">hunger_policy</span></code>: See <span class="xref std std-ref">dispatcher_configuration</span>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_workers</span></code>: Maximum number of workers that can run submissions
simultaneously. For AWS workers, this means the maximum number of
instances that can be run at one time. This should fall within your
AWS instance limit.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_threads</span></code>: The number of threads that each worker can use. This would
depend on the AWS instance type you have choosen.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">time_between_collection</span></code>: How long, in seconds, the worker should wait
before re-checking if the submission is ready for collection. The default is
1 second. For AWS workers the check for collection will be done through SSH.
If the time between checks is too small, the repetitive SSH requests may be
potentially blocked by the cloud provider. We advise to set this
configuration to at least 60 seconds.</p></li>
</ul>
</div>
</div>
<div class="section" id="running-submissions-with-dask">
<h2><span class="section-number">5.3. </span>Running submissions with Dask<a class="headerlink" href="#running-submissions-with-dask" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="generated/ramp_engine.remote.DaskWorker.html#ramp_engine.remote.DaskWorker" title="ramp_engine.remote.DaskWorker"><code class="xref py py-class docutils literal notranslate"><span class="pre">ramp_engine.remote.DaskWorker</span></code></a> allows to run submissions on a Dask
distributed cluster which can be either remote or local.</p>
<p>To setup this worker please follow the instructions below.</p>
<div class="section" id="daskworker-setup-of-the-main-server">
<h3><span class="section-number">5.3.1. </span>DaskWorker setup of the main server<a class="headerlink" href="#daskworker-setup-of-the-main-server" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Setup the <a class="reference internal" href="setup_server.html#setup-server"><span class="std std-ref">ramp_frontend server</span></a> and
<a class="reference internal" href="create_ramp_event.html#deploy-ramp-event"><span class="std std-ref">deploy the RAMP event</span></a>.</p></li>
<li><p>Install dask.distributed,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install <span class="s2">&quot;dask[distributed]&quot;</span>
</pre></div>
</div>
</li>
</ol>
<ol class="arabic" start="2">
<li><p>Start a dask.distributed scheduler,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ dask-scheduler
</pre></div>
</div>
<p>See <a class="reference external" href="https://docs.dask.org/en/latest/setup/cli.html#command-line">dask.distributed documentation</a>
for more information.</p>
</li>
<li><p>Specify the worker in the event configuration as follows,</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">worker</span><span class="p">:</span>
  <span class="nt">worker_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dask</span>
  <span class="nt">conda_env</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ramp-iris</span>
  <span class="nt">dask_scheduler</span><span class="p">:</span> <span class="s">&quot;tcp://127.0.0.1:8786&quot;</span>   <span class="c1"># or another URL to the dask scheduler</span>
  <span class="nt">n_workers</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4</span>  <span class="c1"># (number of RAMP workers launched in parallel. Must be smaller</span>
                <span class="c1">#  than the number of dask.distributed workers)</span>
</pre></div>
</div>
</li>
<li><p>Launch the <a class="reference internal" href="create_ramp_event.html#launch-dispatcher"><span class="std std-ref">RAMP dispatcher</span></a>.</p></li>
</ol>
</div>
<div class="section" id="daskworker-setup-with-a-local-cluster">
<h3><span class="section-number">5.3.2. </span>DaskWorker setup with a local cluster<a class="headerlink" href="#daskworker-setup-with-a-local-cluster" title="Permalink to this headline">¶</a></h3>
<p>To start a local dask.distributed cluster, run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ dask-worker --nprocs <span class="m">10</span>  <span class="c1"># or any appropriate number of workers.</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://docs.dask.org/en/latest/setup/cli.html#command-line">dask.distributed documentation</a>
for more information.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The number of dask.distributed workers (as specified by the <code class="docutils literal notranslate"><span class="pre">--nprocs</span></code>
argument) must be larger, ideally by 50% or so, than the number of RAMP
workers specified in the event configuration. For instance, on a machine
having 16 physical CPUs, you can start 16 RAMP workers, and 32
dask.distributed workers.</p>
<p>This is necessary as some dask.distributed workers will be used for running
the submission, while others manage data and state sychronization.</p>
</div>
</div>
<div class="section" id="daskworker-setup-with-a-remote-cluster">
<h3><span class="section-number">5.3.3. </span>DaskWorker setup with a remote cluster<a class="headerlink" href="#daskworker-setup-with-a-remote-cluster" title="Permalink to this headline">¶</a></h3>
<p>To use a remote dask.distributed cluster, following pre-requisites must be verified.</p>
<ul class="simple">
<li><p>the remote machine must have a <code class="docutils literal notranslate"><span class="pre">ramp_deployment</span></code>
folder with the same absolute path as on the main server</p></li>
<li><p>it must have a <code class="docutils literal notranslate"><span class="pre">base</span></code> (or <code class="docutils literal notranslate"><span class="pre">ramp-board</span></code>) environment  with the same versions of installed
packages as on the main server. Including the same version of <code class="docutils literal notranslate"><span class="pre">dask[distributed]</span></code>.</p></li>
</ul>
<p>The setup steps are then as follows,</p>
<ol class="arabic">
<li><p>Create the conda environment for running event submissions (same name as on
the main server).</p></li>
<li><p>Copy <code class="docutils literal notranslate"><span class="pre">ramp-kit</span></code> and <code class="docutils literal notranslate"><span class="pre">ramp-data</span></code> of the event from the main server, to the
identical paths under the <code class="docutils literal notranslate"><span class="pre">ramp_deployment</span></code> folder.</p></li>
<li><p>Start the dask[distributed] workers,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ dask-worker --nprocs <span class="m">10</span>  <span class="c1"># or any appropriate number of workers.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the Dask scheduler is not in the same local network as the Dask workers,
you would need to start workers as,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>dask-worker tcp://&lt;scheduler-public-ip&gt;:8786 --listen-address <span class="s2">&quot;tcp://0.0.0.0:&lt;port&gt;&quot;</span> --contact-address <span class="s2">&quot;tcp://&lt;worker-public-ip&gt;:&lt;port&gt;</span>
</pre></div>
</div>
<p>This however only works with one dask worker at the time. To start more,
you can use the following bash script,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select the number of dask workers to start.</span>
<span class="c1"># Better to start at idx=10, to keep the number of digits</span>
<span class="c1"># (mapped to the port) constant.</span>
<span class="k">for</span> idx <span class="k">in</span> <span class="o">{</span><span class="m">10</span>..28<span class="o">}</span>
<span class="k">do</span>
    <span class="c1"># start dask worker in the background</span>
    dask-worker tcp://&lt;scheduler-public-ip&gt;:8786 --listen-address <span class="s2">&quot;tcp://0.0.0.0:416</span><span class="si">${</span><span class="nv">idx</span><span class="si">}</span><span class="s2">&quot;</span>   --contact-address <span class="s2">&quot;tcp://&lt;worker-public-ip&gt;:416</span><span class="si">${</span><span class="nv">idx</span><span class="si">}</span><span class="s2">&quot;</span> --nthreads <span class="m">4</span>  <span class="p">&amp;</span>
    sleep <span class="m">0</span>.5
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;Sleeping&quot;</span>
<span class="k">while</span> <span class="o">[</span> <span class="m">1</span> <span class="o">]</span>
<span class="k">do</span>
    sleep <span class="m">1</span>
<span class="k">done</span>

<span class="c1"># On exit kill all children processes (i.e. all workers)</span>
<span class="nb">trap</span> <span class="s2">&quot;trap - SIGTERM &amp;&amp; kill -- -</span><span class="nv">$$</span><span class="s2">&quot;</span> SIGINT SIGTERM EXIT
</pre></div>
</div>
<p>which in particular allows to kill all workers with <code class="docutils literal notranslate"><span class="pre">Ctrl+C</span></code> when interrupting this script.</p>
</div>
</li>
</ol>
<p><strong>Security considerations</strong></p>
<p>By default communications between dask distributed schedulers and workers is
neither encrypted not authenticated which poses security risks. Dask
distributed supports TLS/SSL certifications, however these are not currently
supported in DaskWorker in RAMP.</p>
<p>A workaround for authentication could be to configure a firewall, such as
<a class="reference external" href="https://help.ubuntu.com/community/UFW">UFW</a> to deny connections to dask
related ports, except from pre-defined IPs of dask worker/scheduler.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not run the following command without understanding what they do. You
could lose SSH access to you machine.</p>
</div>
<p>For instance with the UFW firewall on the main server,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ufw</span> <span class="n">allow</span> <span class="mi">22</span><span class="o">/</span><span class="n">tcp</span>   <span class="c1"># allow SSH</span>
<span class="n">sudo</span> <span class="n">ufw</span> <span class="n">allow</span> <span class="mi">80</span>
<span class="n">sudo</span> <span class="n">ufw</span> <span class="n">allow</span> <span class="mi">443</span>      <span class="c1"># allow access to ramp_frontend server over HTTP and HTTPS</span>
<span class="n">sudo</span> <span class="n">ufw</span> <span class="n">allow</span> <span class="kn">from</span> <span class="o">&lt;</span><span class="n">remote</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="n">ip</span><span class="o">&gt;</span>  <span class="c1"># allow access to any port from a given IP</span>
<span class="n">sudo</span> <span class="n">ufw</span> <span class="n">enable</span>
<span class="n">sudo</span> <span class="n">ufw</span> <span class="n">status</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="create-your-own-worker">
<h2><span class="section-number">5.4. </span>Create your own worker<a class="headerlink" href="#create-your-own-worker" title="Permalink to this headline">¶</a></h2>
<p>Currently, the choice of workers in RAMP is quite limited. You might want to
create your own worker for your platform (Openstack, Azure, etc.). This section
illustrates how to implement your own worker.</p>
<p>Your new worker should subclass <a class="reference internal" href="generated/ramp_engine.base.BaseWorker.html#ramp_engine.base.BaseWorker" title="ramp_engine.base.BaseWorker"><code class="xref py py-class docutils literal notranslate"><span class="pre">ramp_engine.base.BaseWorker</span></code></a>. This
class implements some basic functionalities which you should use.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">setup</span></code> function will initialize the worker before it can be used, e.g.
activate the right conda environment. Your worker should implement this class
and call <code class="docutils literal notranslate"><span class="pre">super</span></code> at the end of it. Indeed, the base class is in charge of
updating the status of the worker and logging some information. Thus, your
function should look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="c1"># implement some initialization for instance launch an</span>
      <span class="c1"># Openstack instance</span>
      <span class="k">assert</span> <span class="kc">True</span>
      <span class="c1"># call the base class to update the status and log</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
<p>Similarly, you might need to make some operation to release the worker. Then,
the function <code class="docutils literal notranslate"><span class="pre">teardown</span></code> is in charge of this. It should be called similarly
to the <code class="docutils literal notranslate"><span class="pre">setup</span></code> function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="c1"># clean some jobs done by the worker</span>
      <span class="c1"># ...</span>
      <span class="c1"># call the base class to update the status and log</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">teardown</span><span class="p">()</span>
</pre></div>
</div>
<p>The actual job of the worker should be implemented in <code class="docutils literal notranslate"><span class="pre">launch_submission</span></code> in
charge of running a submission and <code class="docutils literal notranslate"><span class="pre">collect_results</span></code> in charge of collecting
and paste them in the location indicated by the dispatcher. As for the other
previous functions, you should call <code class="docutils literal notranslate"><span class="pre">super</span></code> at the end of the processing to
update the status of the worker:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">launch_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="c1"># launch ramp test --submission &lt;sub&gt; --save-output on the Openstack</span>
      <span class="c1"># instance</span>
      <span class="o">...</span>
      <span class="c1"># call the base class to update the status and log</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">launch_submission</span><span class="p">()</span>
</pre></div>
</div>
<p>Once a submission is trained, the <code class="docutils literal notranslate"><span class="pre">ramp</span> <span class="pre">test</span></code> command line would store the
results and you should upload those in the directory indicated by the
dispatcher:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">collect_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="c1"># the base class will be in charge of checking that the state of</span>
      <span class="c1"># the worker is fine</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect_results</span><span class="p">()</span>
      <span class="c1"># write the prediction and logs at the location indicated by the</span>
      <span class="c1"># dispatcher (given by the config file)</span>
      <span class="n">log_output</span> <span class="o">=</span> <span class="n">stdout</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">stderr</span>
      <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;logs_dir&#39;</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">submission</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_dir</span><span class="p">):</span>
          <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">),</span> <span class="s1">&#39;wb+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
          <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_output</span><span class="p">)</span>
      <span class="n">pred_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;predictions_dir&#39;</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">submission</span><span class="p">)</span>
      <span class="n">output_training_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;submissions_dir&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">submission</span><span class="p">,</span>
          <span class="s1">&#39;training_output&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pred_dir</span><span class="p">):</span>
          <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">pred_dir</span><span class="p">)</span>
      <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">output_training_dir</span><span class="p">,</span> <span class="n">pred_dir</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;collected&#39;</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
      <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>
</pre></div>
</div>
<p>You need to implement the <code class="docutils literal notranslate"><span class="pre">_is_submission_finished</span></code> function to indicate the
worker that he can call the <code class="docutils literal notranslate"><span class="pre">collect_results</span></code> function. This function will
be dependent of the platform that you are using. For instance, for a conda
worker, it would look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_is_submission_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Status of the submission.</span>

<span class="sd">  The submission was launched in a subprocess. Calling ``poll()`` will</span>
<span class="sd">  indicate the status of this subprocess.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="kc">False</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="frontend.html" class="btn btn-neutral float-right" title="6. Interactions with the RAMP website" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="create_new_challenge.html" class="btn btn-neutral float-left" title="4. Create New Challenge" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015 - 2019, Paris-Saclay Center for Data Science

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>